# 아이템 55. 옵셔널 반환은 신중히 하라

## 자바 8 이전

자바 8 이전, 메서드가 특정 조건에서 값을 반환할 수 없을 때 취할 수 있는 선택지

- 예외를 던지기
- (반환 타입이 객체 참조라면) null을 반환하기

두 방식 모두 허점이 존재한다.

- 예외를 던지기
  - 예외는 진짜 예외적인 상황에서만 사용해야 함
  - 예외를 생성할 때 스택 추적 전체를 캡쳐하므로 비용도 만만치 않음
- (반환 타입이 객체 참조라면) null을 반환하기

  - 별도의 null 처리 코드를 추가해야 함
  - 언젠가 NPE 발생할 수 있음

## 자바 8 이후

> Optional<T>의 등장

Optional<T>는 null이 아닌 T 타입 참조를 하나 담거나, 혹은 아무것도 담지 않을 수 있다.
아무것도 담지 않은 옵셔널은 `비었다` 고 말한다.
옵셔널 : 원소를 최대 1개 가질 수 있는 불변 컬렉션

보통 T를 반환해야 하지만 특정 조건에서는 아무것도 반환하지 않아야 할 때 T 대신 Optional<T>를 반환하도록 선언
→ 유효한 반환값이 없을 때는 빈 결과를 반환하는 메서드가 만들어진다.
옵셔널을 반환하는 메서드는 예외를 던지는 메서드보다 유연하고 사용하기 쉬우며, null을 반환하는 메서드보다 오류 가능성이 적다.

### 옵셔널 생성 방법

빈 옵셔널 : Optional.empty()

값이 든 옵셔널 : Optional.of(value)

→ Optional.of(value) 에 null을 넣으면 NullPointerException 발생 (주의!)

null 값도 허용하는 옵셔널 : Optional.ofNullable(value)

옵셔널을 반환하는 메서드에서는 절대 null을 반환하면 안된다.
→ 옵셔널을 도입한 취지를 완전히 무시하는 행위

### null을 반환하거나 예외를 던지는 대신 옵셔널 반환을 선택해야 하는 기준

옵셔널은 검사 예외와 취지가 비슷하다.
→ 반환 값이 없을 수도 있음을 API 사용자에게 명확히 알려준다.

비검사 예외를 던지거나 null을 반환하면 API 사용자가 그 사실을 인지하지 못해 끔찍한 결과로 이어질 수 있다.
메서드가 옵셔널을 반환한다면 클라이언트는 값을 받지 못했을 때 취할 행동을 선택해야 한다.

> 옵셔널 반환 시 클라이언트에서 취할 수 있는 행동

- 기본값을 설정
  - `orElse`
- 원하는 예외 던지기
  - `orElseThrow`
- 항상 값이 채워져있다고 가정
  - `get`
    - 만약 곧바로 값을 꺼냈지만, 없다면 `NoSuchElementException` 발생

기본값을 설정하는 비용이 아주 커서 부담이 되는 경우,
→ Supplier<T>를 인수로 받는 `orElseGet` 사용
→ 값이 처음 필요할 때 Supplier<T>를 사용해 생성하므로 초기 설정 비용을 낮출 수 있다.

> 더 특별한 쓰임에 대비한 메서드

- filter
- map
- flatMap
- ifPresent

위 메서드들로도 적합한 메서드를 찾지 못했다면, `isPresent` 메서드 사용

안전밸브 역할의 메서드

- 옵셔널이 채워져 있으면 true
- 비어 있으면 false

이 메서드로는 원하는 모든 작업을 수행 가능하지만, 신중히 사용해야 한다.

→ 위에 언급한 메서드들로 대체 가능 → 더 짧고 명확하고 용법에 맞는 코드로 변할 수 있음

### 옵셔널과 스트림

자바 9에서 Optional에 stream() 메서드가 추가되었다.
Optional을 Stream으로 변환해주는 어댑터

- 옵셔널에 값이 있으면 그 값을 원소로 담은 스트림으로
- 값이 없다면 빈 스트림으로 변환

```java
streamOfOptionals
	.flatMap(Optional::stream)
```

### 옵셔널 사용 시 주의할 점

컬렉션, 스트림, 배열, 옵셔널 같은 컨테이너 타입은 옵셔널로 감싸면 안 된다.

### Optional<T>로 선언해야 하는 경우

메서드 반환 타입을 T 대신 Optional<T>로 선언해야 하는 경우는

- 결과가 없을 수 있으며
- 클라이언트가 이 상황을 특별하게 처리해야 하는 경우

Optional<T>를 반환한다.

Optional도 엄연히 새로 할당하고 초기화해야하는 객체이고, 그 안에서 값을 꺼내려면 메서드를 호출해야 하니 한 단계를 더 거치게 된다.

따라서, 성능이 중요한 상황에서는 옵셔널이 맞지 않을 수 있다.

## 정리

값을 반환하지 못할 가능성이 있고, 호출할 때마다 반환 값이 없을 가능성을 염두에 둬야하는 메서드라면 옵셔널을 반환해야 하는 상황일 수 있다.

하지만, 옵셔널 반환에는 성능 저하가 뒤따르니, 성능에 민감한 메서드라면 null을 반환하거나 예외를 던지는 편이 나을 수 있다.
