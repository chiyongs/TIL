#### 해당 TIL은 **최원영님의 아파치 카프카 애플리케이션 프로그래밍 with 자바** 책으로 공부한 내용을 정리한 글입니다.
<img src="images/아파치 카프카 애플리케이션 프로그래밍 with 자바.jpeg" alt="">

## 실습용 카프카 브로커 설치
AWS EC2 인스턴스를 생성하고 해당 인스턴스에 카프카를 구축한다.
<img src="images/EC2 생성.png">
Amazon Machine Image는 Amazon Linux 2를 선택한다.
Amazon Linux 2는 Amazon에서 직접 만든 템플릿으로 EC2에 최적화되어 있다.

### AWS EC2 아키텍처 유형
<img src="images/EC2 아키텍처 유형.png">
아키텍처 유형에는 x86과 Arm 아키텍처 두 가지가 존재하는데 Intel 칩 기반 x86을 선택한다.

### AWS EC2 인스턴스 유형
<img src="images/EC2 인스턴스 유형.png">
EC2 인스턴스 유형은 프리티어로 사용할 수 있는 t2.micro로 설정한다.

### AWS EC2 인바운드 규칙
<img src="images/EC2 인바운드 규칙.png">
- 카프카 브로커의 기본 포트 : 9092
- 주키퍼의 기본 포트 : 2181

카프카 브로커와 주키퍼 접근을 위해 두 포트에 대한 인바운드 규칙을 추가한다.

### ssh 접속
<img src="images/EC2 ssh 접속.png">
EC2 생성 시 만든 pem키를 사용해 로컬에서 EC2 인스턴스로 ssh 접속한다.

### 인스턴스에 자바 설치
카프카 브로커를 실행하기 위해서는 JDK가 필요하다.
카프카 브로커는 스칼라와 자바로 작성되어 JVM 환경 위에서 실행되기 때문이다.
```shell
$ sudo yum install -y java-1.8.0-openjdk.devel.x86_64
```
<img src="images/Java 버전.png">

### 주키퍼, 카프카 브로커 실행
```shell
$ wget https://archive.apache.org/dist/kafka/2.5.0/kafka_2.12-2.5.0.tgz
```
<img src="images/카프카 바이너리 패키지 다운로드.png">
카프카 브로커를 실행하기 위해 카프카 바이너리 패키지를 다운로드한다.

다운로드 후 압축파일을 푼다.
```shell
$ tar xvf kafka_2.12-2.5.0.tgz
```

### 카프카 브로커 힙 메모리 설정
카프카 패키지의 힙 메모리는 카프카 브로커가 1G, 주키퍼가 512MB로 기본 설정되어 있다.


따라서, 생성한 EC2 인스턴스(t2.micro)는 1G의 메모리를 가지고 있기 때문에 기본 설정 그대로 실행하게 된다면 메모리가 부족하여 실행되지 않는다.

이를 해결하기 위해 export 명령어를 사용해 힙 메모리 사이즈를 미리 환경변수로 지정한다.
```shell
$ export KAFKA_HEAP_OPTS="-Xmx400m -Xmx400m"
```

### 주키퍼 실행
주키퍼는 카프카 바이너리가 포함된 폴더에 같이 존재한다.

주키퍼는 분산 코디네이션 서비스를 제공하며 카프카를 실행하는 데에 필요한 필수 애플리케이션이다.

주키퍼를 상용환경에서 안전하게 운영하기 위해서는 3대 이상의 서버로 구성하여 사용해야 하지만 본 실습에서는 1대로 실행한다.

1대만 실행하는 주키퍼를 `Quick-and-dirty single-node`라고 한다.

```shell
$ bin/zookeeper-server-start.sh -daemon config/zookeeper.properties
```

### 카프카 브로커 실행
```shell
$ bin/kafka-server-start.sh -daemon config/server.properties
```
카프카가 정상적으로 연결되지 않거나 데이터가 전송되지 않거나 하는 등의 이슈가 발생할 경우 모드 카프카 브로커에 로그가 남기 때문에 이슈가 발생하면 로그를 최우선으로 확인해야 한다.
