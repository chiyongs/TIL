# 대규모 경품 추천 이벤트 시스템

요구사항 : 유저 유입을 위해 경품 추천 시스템
1등에게 TV를 보내주는 이벤트

현재 서비스에는 유저가 1,000,000명 존재, 이벤트는 아침 09시에 시작

예상 트래픽 100,000 정도 예상

경품 추천 버튼을 누르자마자 당첨인지 아닌지 알 수 있어야 함.
(조건 : 유저는 단 1회만 경품 추천 시도 가능)

구현 요소

- 1등 선별 방법
- 당첨자가 나왔을 때의 후처리 방법
- 요청을 감당하는 방법

### 1등 선별 방법

1. 유저가 경품 추천 버튼을 눌렀을 때, 각 유저마다 1 / 1,000,000 로직을 돌려서 당첨 여부 확인시키기
2. 당첨이 되었을 경우 -> 후처리

매 유저마다 1 / 1,000,000 로직을 돌리는 것은 효율적이지 않다.
-> N번째 누른 유저를 당첨시키자.
-> N이 몇인지는 공개하지 않고, N을 선별하는 로직을 난수로 처리

유저의 경품 추천 요청들의 순서를 저장해놓고 특정 순서에 해당하는 유저에게 당첨 상품을 준다.

### 당첨자가 나왔을 때의 후처리 방법

1. 당첨자가 나오면 이미 상품이 없기 때문에, 버튼을 닫아놓는다.
2. 익명성 있게 당첨이 되었는지, 안 되었는지 모르게 하려면 당첨 이후의 요청들은 API 쏘지말고 클라이언트에서 버튼 누르는 애니메이션이랑 당첨 실패 페이지가 바로 보이도록 UI 구현 -> 당첨 이후에는 서버 통신 X

### 요청을 감당하는 방법

초당 100,000? 300,000으로 증가할 수도 있다 가정

데이터 저장 공간부터 선택
이벤트는 단기성 추첨 이벤트 -> 데이터를 장기적으로 보관 X
순서 기록이 필요 -> 순차적으로 기록되는 것이 보장되어야 하고, 쓰기 연산이 많음
따라서, NoSQL, LSM Tree 인덱스 구조를 가지고 있는 DB (LevelDB, RocksDB 등등)
B-Tree 구조의 DB는 쓰기 throughput을 고려하여 사용하지 않는 것이 좋을 듯

스파이크성 요청들을 잘 분산해야 하고,
scale-out을 했다면 요청 순서와 경품 기록 등을 잘 미러링해서 동시성 이슈가 발생하지 않도록, 데이터 일관성과 정합성 문제를 잘 해결해야 함

scale out, scale up 등등 했는데 인프라 예산이 부족하여 요청을 전부 받는 서버를 확장하기에 부족하다면...?

서버에 들어오는 요청들을 max-connection이나 커넥션 임계값을 설정해놓고 들어오는 요청에 대해서 일정한 값씩 처리하는 방법도 존재
-> 쓰로틀링 -> 요청 처리시간은 느려질 수 있음
이 경우 유저 경험은 낮아질 순 있는데 서버가 죽는 것보단 나으니 이렇게 대처해볼 수도 있다.

### 이벤트 당첨자가 발생했을 때 이벤트 종료를 모든 유저에게 알림을 보내는 경우

당첨되었을 때, 모든 유저한테 당첨되었다는 event를 받고 배치프로그램이 알림 발송
